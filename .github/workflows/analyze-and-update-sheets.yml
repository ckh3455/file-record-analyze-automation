name: analyze-and-update-sheets

on:
  workflow_dispatch:
  schedule:
    - cron: "30 23 * * *"  # KST 08:30

permissions:
  contents: read
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    env:
      CI: "1"
      PYTHONUNBUFFERED: "1"
      TZ: Asia/Seoul
      SHEET_ID: ${{ secrets.SHEET_ID }}
      SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      SOURCE_REPO_PAT: ${{ secrets.SOURCE_REPO_PAT }}
      SRC_REPO: ckh3455/file-automation
      SRC_WORKFLOW: molit.yml
      SRC_ARTIFACT: molit-xlsx

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 최신 성공 run 아티팩트 다운로드 + 신선도 검사:
      # (A) 업스트림 run updatedAt <= 6h  OR  (B) 파일 mtime <= 12h
      # 불충족 시 15분 간격 재시도, 최대 6회
      - name: Download artifacts with freshness guard (retry)
        id: fetch
        shell: bash
        env:
          MAX_TRIES: "6"
          RETRY_MIN: "15"
        run: |
          set -euo pipefail

          echo "::group::Authenticate gh"
          echo "${SOURCE_REPO_PAT}" | gh auth login --with-token
          gh --version
          echo "::endgroup::"

          rm -rf artifacts
          mkdir -p artifacts

          try=1
          while :; do
            echo "::group::[try ${try}] locate latest SUCCESS run"
            RUN_JSON="$(gh run list -R "${SRC_REPO}" \
              --workflow "${SRC_WORKFLOW}" \
              --status success \
              --json databaseId,displayTitle,updatedAt \
              --limit 1 || true)"
            echo "RUN_JSON=${RUN_JSON}"
            RUN_ID="$(echo "${RUN_JSON}" | jq -r '.[0].databaseId // empty')"
            RUN_UPDATED="$(echo "${RUN_JSON}" | jq -r '.[0].updatedAt // empty')" # ISO-8601 UTC
            RUN_TITLE="$(echo "${RUN_JSON}" | jq -r '.[0].displayTitle // empty')"
            echo "RUN_ID=${RUN_ID}"
            echo "RUN_UPDATED(UTC)=${RUN_UPDATED}"
            echo "RUN_TITLE=${RUN_TITLE}"
            echo "::endgroup::"

            rc=0
            if [ -z "${RUN_ID}" ] || [ -z "${RUN_UPDATED}" ]; then
              echo "::warning::no successful run found yet."
              rc=66
            else
              echo "::group::download artifact ${SRC_ARTIFACT} (run ${RUN_ID})"
              rm -rf artifacts/*
              if ! gh run download "${RUN_ID}" -R "${SRC_REPO}" -n "${SRC_ARTIFACT}" -D artifacts; then
                echo "::warning::artifact download failed."
                rc=66
              fi
              echo "::endgroup::"
            fi

            # 신선도: (A) run age <= 6h OR (B) file mtime <= 12h
            if [ ${rc} -eq 0 ]; then
              echo "::group::Freshness check (run<=6h OR files<=12h), verbose logs"
              NOW_EPOCH="$(date -u +%s)"

              # (A) 업스트림 run age
              FRESH_BY_RUN=0
              if [ -n "${RUN_UPDATED:-}" ]; then
                RUN_EPOCH="$(date -u -d "${RUN_UPDATED}" +%s || echo 0)"
                RUN_AGE_H="$(awk "BEGIN{print (${NOW_EPOCH}-${RUN_EPOCH})/3600}")"
                echo "Upstream run updatedAt(UTC): ${RUN_UPDATED} | age_hours=${RUN_AGE_H}"
                awk "BEGIN{exit !(${RUN_AGE_H} <= 6.0)}" && FRESH_BY_RUN=1 || true
                [ "${FRESH_BY_RUN}" = "1" ] && echo "RESULT: FRESH by upstream run age (<=6h) ✓"
              else
                echo "No RUN_UPDATED value found."
              fi

              # (B) 파일 mtime 기준
              FRESH_BY_FILE=0
              file_count=$(find artifacts -type f -name '*.xlsx' | wc -l | tr -d ' ')
              echo "xlsx files in artifacts: ${file_count}"
              if [ "${file_count}" = "0" ]; then
                echo "NO XLSX FILES in artifacts directory."
              else
                latest_line="$(find artifacts -type f -name '*.xlsx' -printf '%T@ %p\n' | sort -n | tail -1)"
                latest_path="${latest_line#* }"
                latest_epoch_utc="$(stat -c %Y "${latest_path}")"
                mod_utc_str="$(date -u -d @"${latest_epoch_utc}" '+%F %T')"
                mod_kst_str="$(date -u -d "$((latest_epoch_utc+9*3600))" '+%F %T')"
                AGE_H="$(awk "BEGIN{print (${NOW_EPOCH}-${latest_epoch_utc})/3600}")"
                echo "Latest: ${latest_path} | mtime(UTC)=${mod_utc_str} | mtime(KST)=${mod_kst_str} | age_hours=${AGE_H}"
                awk "BEGIN{exit !(${AGE_H} <= 12.0)}" && FRESH_BY_FILE=1 || true
                [ "${FRESH_BY_FILE}" = "1" ] && echo "RESULT: FRESH by file mtime (<=12h) ✓"
              fi

              if [ "${FRESH_BY_RUN}" = "1" ] || [ "${FRESH_BY_FILE}" = "1" ]; then
                echo "FRESH ✓ (run or file)"
              else
                echo "RESULT: STALE → retry later"
                rc=66
              fi
              echo "::endgroup::"
            fi

            if [ ${rc} -eq 0 ]; then
              echo "fresh artifacts detected."
              break
            fi

            if [ ${try} -ge ${MAX_TRIES} ]; then
              echo "::error::no fresh artifacts after ${try} tries."
              exit 1
            fi

            echo "::notice::stale or not ready. retry in ${RETRY_MIN} minutes (next try: $((try+1))/${MAX_TRIES})."
            sleep "$((RETRY_MIN*60))"
            try=$((try+1))
          done

          echo "OK" > .fresh_ok

      - name: List downloaded files
        run: |
          find artifacts -type f -printf "%TY-%Tm-%Td %TT %p\n" | sort || true

      - name: Run analysis & update
        if: ${{ hashFiles('.fresh_ok') != '' }}
        env:
          ARTIFACTS_DIR: artifacts
        run: |
          python scripts/analyze_and_update.py \
            --artifacts-dir artifacts \
            --sheet-id "$SHEET_ID"

      - name: Preview analyze_report (always)
        if: always()
        run: |
          echo "== analyze_report tree =="; ls -alR analyze_report || true
          echo "---- latest.log (head) ----"; sed -n '1,220p' analyze_report/latest.log || true
          echo "---- run logs list ----"; ls -al analyze_report/run-*.log 2>/dev/null || true
          echo "---- where_written.txt ----"; cat analyze_report/where_written.txt 2>/dev/null || true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyze-report
          path: analyze_report/**
          retention-days: 14
          compression-level: 6
