name: analyze-and-update-sheets

on:
  workflow_dispatch:
  schedule:
    - cron: "30 23 * * *"  # KST 08:30

permissions:
  contents: read
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    env:
      CI: "1"
      PYTHONUNBUFFERED: "1"
      TZ: Asia/Seoul
      SHEET_ID: ${{ secrets.SHEET_ID }}
      SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      SOURCE_REPO_PAT: ${{ secrets.SOURCE_REPO_PAT }}
      SRC_REPO: ckh3455/file-automation
      SRC_WORKFLOW: molit.yml
      SRC_ARTIFACT: molit-xlsx

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # === ÏïÑÌã∞Ìå©Ìä∏ Îã§Ïö¥Î°úÎìú + ÌååÏùºÎ™Ö ÎÇ†Ïßú(YYMMDD) = Ïò§Îäò(KST) Í≤ÄÏÇ¨ + (Î∞±ÏóÖ) ÏàòÏ†ïÏãúÍ∞Ñ 12h Ïã†ÏÑ†ÎèÑ ===
      - name: Download artifacts with filename-date freshness guard (retry every 15 min)
        id: fetch
        shell: bash
        env:
          MAX_TRIES: "6"
          RETRY_MIN: "15"
        run: |
          set -euo pipefail

          echo "${SOURCE_REPO_PAT}" | gh auth login --with-token

          rm -rf artifacts
          mkdir -p artifacts

          try=1
          while :; do
            echo "::group::[try ${try}] find latest SUCCESS run"
            RUN_JSON="$(gh run list -R "${SRC_REPO}" \
              --workflow "${SRC_WORKFLOW}" \
              --status success \
              --json databaseId,displayTitle,updatedAt \
              --limit 1)"
            echo "RUN_JSON=${RUN_JSON}"
            RUN_ID="$(echo "${RUN_JSON}" | jq -r '.[0].databaseId // empty')"
            RUN_UPDATED="$(echo "${RUN_JSON}" | jq -r '.[0].updatedAt // empty')"
            RUN_TITLE="$(echo "${RUN_JSON}" | jq -r '.[0].displayTitle // empty')"
            echo "RUN_ID=${RUN_ID}"
            echo "RUN_UPDATED(UTC)=${RUN_UPDATED}"
            echo "RUN_TITLE=${RUN_TITLE}"
            echo "::endgroup::"

            rc=0
            if [ -z "${RUN_ID}" ]; then
              echo "::warning::No successful run found yet."
              rc=66
            else
              echo "::group::List artifacts of the run"
              ART_NAMES="$(gh api repos/${SRC_REPO}/actions/runs/${RUN_ID}/artifacts --jq '.artifacts[].name')"
              echo "Artifacts on run ${RUN_ID}:"
              echo "${ART_NAMES:-<none>}"
              echo "::endgroup::"

              rm -rf artifacts/*

              # 1) Ï†ïÌôï Ïù¥Î¶Ñ Ïö∞ÏÑ† Îã§Ïö¥Î°úÎìú
              if [ -n "${ART_NAMES}" ] && grep -Fxq "${SRC_ARTIFACT}" <<<"${ART_NAMES}"; then
                echo "::group::Download artifact (exact): ${SRC_ARTIFACT}"
                if ! gh run download "${RUN_ID}" -R "${SRC_REPO}" -n "${SRC_ARTIFACT}" -D artifacts; then
                  echo "::warning::Exact artifact download failed."
                  rc=66
                fi
                echo "::endgroup::"
              else
                echo "::notice::'${SRC_ARTIFACT}' not found. Fallback: download all artifacts of the run."
                if [ -n "${ART_NAMES}" ]; then
                  while IFS= read -r NAME; do
                    [ -z "${NAME}" ] && continue
                    echo "::group::Download artifact (fallback): ${NAME}"
                    gh run download "${RUN_ID}" -R "${SRC_REPO}" -n "${NAME}" -D artifacts || true
                    echo "::endgroup::"
                  done <<< "${ART_NAMES}"
                else
                  echo "::warning::This run has zero artifacts."
                  rc=66
                fi
              fi

              XLSX_COUNT="$(find artifacts -type f -name '*.xlsx' | wc -l | tr -d ' ')"
              echo "xlsx files downloaded: ${XLSX_COUNT}"
              if [ "${XLSX_COUNT}" -eq 0 ]; then
                rc=66
              fi
            fi

            # ‚úÖ 1ÏàúÏúÑ: ÌååÏùºÎ™Ö ÎÇ†Ïßú(YYMMDD) = Ïò§Îäò(KST) Í≤ÄÏÇ¨ + ÏÉÅÏÑ∏ Î°úÍ∑∏
            if [ ${rc} -eq 0 ]; then
              echo "::group::Filename date check (YYMMDD == today KST)"
              TODAY_YMD="$(date +'%y%m%d')"   # TZ=Asia/Seoul in job env
              echo "TODAY_YMD(KST)=${TODAY_YMD}"
              MATCH=0
              # ÏÉÅÏÑ∏ ÎπÑÍµê Î°úÍ∑∏
              while IFS= read -r f; do
                base="$(basename "$f")"
                # ÌååÏùºÎ™ÖÏóêÏÑú 6ÏûêÎ¶¨ Ïà´Ïûê ÌÜ†ÌÅ∞ Ï∂îÏ∂ú (Ïó¨Îü¨ Í∞úÎ©¥ Î™®Îëê ÎπÑÍµê)
                ymd_tokens="$(echo "$base" | grep -Eo '[0-9]{6}' || true)"
                if [ -z "$ymd_tokens" ]; then
                  echo "NO-DATE  | $base"
                  continue
                fi
                hit="NO"
                while IFS= read -r tok; do
                  [ -z "$tok" ] && continue
                  if [ "$tok" = "$TODAY_YMD" ]; then
                    hit="YES"
                    MATCH=$((MATCH+1))
                  fi
                done <<< "$ymd_tokens"
                if [ "$hit" = "YES" ]; then
                  echo "MATCH    | $base (tokens: $ymd_tokens)"
                else
                  echo "MISMATCH | $base (tokens: $ymd_tokens)"
                fi
              done < <(find artifacts -type f -name '*.xlsx' | sort)

              if [ "$MATCH" -gt 0 ]; then
                echo "RESULT: Filename-date MATCH ‚úì  (matched_files=${MATCH})"
                rc=0
              else
                echo "RESULT: No filename-date match ‚Üí will use freshness fallback."
                rc=1
              fi
              echo "::endgroup::"
            fi

            # üîÅ 2ÏàúÏúÑ Î∞±ÏóÖ: ÏàòÏ†ïÏãúÍ∞Ñ Ïã†ÏÑ†ÎèÑ(<=12h, KST) + ÏÉÅÏÑ∏ Î°úÍ∑∏
            if [ ${rc} -ne 0 ]; then
              echo "::group::Freshness fallback (<=12h, KST)"
              KST_NOW_SEC=$(( $(date -u +%s) + 9*3600 ))
              mapfile -t LINES < <(find artifacts -type f -name '*.xlsx' -printf '%T@ %p\n' | sort -n)
              if [ "${#LINES[@]}" -eq 0 ]; then
                echo "No .xlsx ‚Üí stale"
                rc=66
              else
                echo "Last 10 files by mtime (KST):"
                for line in "${LINES[@]: -10}"; do
                  ts="${line%% *}"; file="${line#* }"
                  ts_int="${ts%.*}"
                  kst_time="$(date -d "@$((ts_int-9*3600))" -u +'%Y-%m-%d %H:%M:%S')"
                  # ÏúÑÎäî UTC Ï∂úÎ†•Ïù¥Îùº Î≥¥Í∏∞Í∞Ä Ïï†Îß§ÌïòÎãà Í∑∏ÎÉ• Ï¥àÎ°ú ÎÇòÏù¥ Ï∂úÎ†•
                  age_sec=$(( KST_NOW_SEC - ts_int ))
                  echo "- ${file} | age_sec=${age_sec}"
                done
                LAST_LINE="${LINES[-1]}"
                LAST_TS_FLOAT="${LAST_LINE%% *}"
                LAST_FILE="${LAST_LINE#* }"
                LAST_TS_INT="${LAST_TS_FLOAT%.*}"
                LAST_AGE_SEC=$(( KST_NOW_SEC - LAST_TS_INT ))
                echo "latest file: ${LAST_FILE}"
                echo "latest age sec: ${LAST_AGE_SEC}"
                if [ "$LAST_AGE_SEC" -gt 43200 ]; then
                  echo "RESULT: STALE (>12h) ‚Üí retry"
                  rc=66
                else
                  echo "RESULT: FRESH by age ‚úì"
                  rc=0
                fi
              fi
              echo "::endgroup::"
            fi

            if [ ${rc} -eq 0 ]; then
              echo "Artifacts ready. Proceed."
              break
            fi

            if [ ${try} -ge ${MAX_TRIES} ]; then
              echo "::error::Not ready after ${try} tries."
              exit 1
            fi

            echo "::notice::Retry in ${RETRY_MIN} minutes (next try: $((try+1))/${MAX_TRIES})."
            sleep "$((RETRY_MIN*60))"
            try=$((try+1))
          done

          echo "OK" > .fresh_ok

      - name: List downloaded files
        run: |
          find artifacts -type f -printf "%TY-%Tm-%Td %TT %p\n" | sort || true

      - name: Run analysis & update
        if: ${{ hashFiles('.fresh_ok') != '' }}
        env:
          ARTIFACTS_DIR: artifacts
        run: |
          python scripts/analyze_and_update.py \
            --artifacts-dir artifacts \
            --sheet-id "$SHEET_ID"

      - name: Preview analyze_report (always)
        if: always()
        run: |
          echo "== analyze_report tree =="; ls -alR analyze_report || true
          echo "---- latest.log (head) ----"; sed -n '1,220p' analyze_report/latest.log || true
          echo "---- run logs list ----"; ls -al analyze_report/run-*.log 2>/dev/null || true
          echo "---- where_written.txt ----"; cat analyze_report/where_written.txt 2>/dev/null || true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyze-report
          path: analyze_report/**
          retention-days: 14
          compression-level: 6
