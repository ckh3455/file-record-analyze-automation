name: molit

on:
  schedule:
    - cron: '05 0 * * *'   # UTC 00:05 = KST 09:05
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CI: '1'
      PYTHONUNBUFFERED: '1'
      TZ: Asia/Seoul

      # 기존 환경변수 유지(다운로더에서 쓸 수 있음)
      ARTIFACTS_ONLY: '1'
      DOWNLOAD_TIMEOUT: '30'
      CLICK_RETRY_MAX: '15'
      CLICK_RETRY_WAIT: '1'

      # 다운로더가 OUTPUT_DIR 지원하면 이 값 사용 가능 (지원 안 해도 output dir 만들어둠)
      OUTPUT_DIR: output

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chromium & Chromedriver
        run: |
          set -euxo pipefail
          sudo apt-get update
          # ubuntu-latest에서 패키지명이 달라질 수 있어 2개 경로를 모두 시도
          sudo apt-get install -y chromium-browser chromium-chromedriver || sudo apt-get install -y chromium chromium-driver

          # Chrome binary path 설정
          if [ -x /usr/bin/chromium-browser ]; then
            echo "CHROME_BIN=/usr/bin/chromium-browser" >> "$GITHUB_ENV"
          elif [ -x /usr/bin/chromium ]; then
            echo "CHROME_BIN=/usr/bin/chromium" >> "$GITHUB_ENV"
          else
            echo "Chromium not found" >&2
            exit 1
          fi

          # Driver path 설정
          if [ -x /usr/bin/chromedriver ]; then
            echo "CHROMEDRIVER_BIN=/usr/bin/chromedriver" >> "$GITHUB_ENV"
          elif [ -x /usr/bin/chromium-driver ]; then
            echo "CHROMEDRIVER_BIN=/usr/bin/chromium-driver" >> "$GITHUB_ENV"
          else
            echo "Chromedriver not found" >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare output dir
        run: |
          set -euxo pipefail
          # 과거 실수로 output이 '파일'로 존재했던 케이스 방지
          if [ -f output ]; then
            echo "WARN: 'output' exists as a file. Removing it."
            rm -f output
          fi
          mkdir -p output
          ls -ald output

      - name: Pre-debug (before run)
        run: |
          set -euxo pipefail
          pwd
          ls -al
          ls -al output || true

      # ✅ 생성 주체를 download_realdata.py로 통일
      - name: Run downloader & preprocess
        run: |
          set -euxo pipefail
          python download_realdata.py

      - name: Post-debug (after run) - list outputs
        run: |
          set -euxo pipefail
          echo "=== find xlsx (maxdepth 6) ==="
          find . -maxdepth 6 -type f -name "*.xlsx" -print
          echo "=== list output/ ==="
          ls -al output || true

      - name: Assert xlsx exists under output/
        run: |
          set -euxo pipefail
          cnt=$(find output -type f -name "*.xlsx" | wc -l)
          echo "xlsx in output/: $cnt"
          test "$cnt" -gt 0

      - name: Upload artifacts (processed xlsx)
        uses: actions/upload-artifact@v4
        with:
          name: molit-xlsx
          path: output/**/*.xlsx
          if-no-files-found: error
          retention-days: 3
