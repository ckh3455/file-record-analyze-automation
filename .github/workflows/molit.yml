name: molit

on:
  schedule:
    - cron: "05 0 * * *" # KST 09:05
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      CI: "1"
      PYTHONUNBUFFERED: "1"
      TZ: "Asia/Seoul"

      # === 대상 구글시트 ===
      SHEET_ID: ${{ secrets.SHEET_ID }}

      # === 서비스계정 JSON ===
      SA_JSON: ${{ secrets.SA_JSON }}

      # === Drive 폴더 설정(필수) ===
      # 네가 준 "부동산자료" 폴더 ID
      DRIVE_PARENT_FOLDER_ID: "1Og3ksryf4L25sjl-w3fKDn2U5OlWLt9E"
      DRIVE_SUBFOLDER_NAME: "아파트"

      # 공유드라이브/바로가기 대응 옵션
      DRIVE_SUPPORTS_ALL_DRIVES: "true"
      DRIVE_CORPUS: "allDrives"

      # 시트 날짜행 스캔 범위(선택)
      MAX_SCAN_ROWS: "900"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Drive API 모듈 확실히 설치
          pip install "google-api-python-client>=2.0.0" "google-auth>=2.0.0" "google-auth-httplib2>=0.2.0"

      - name: Run analyzer (Drive -> Sheets)
        run: |
          set -euxo pipefail
          python scripts/analyze_and_update.py

      - name: Upload analyze report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyze-report
          path: analyze_report/**
          if-no-files-found: warn
          retention-days: 3
