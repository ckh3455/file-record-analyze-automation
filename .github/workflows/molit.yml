name: molit

on:
  schedule:
    - cron: '05 0 * * *'   # UTC 00:05 = KST 09:05
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CI: '1'
      PYTHONUNBUFFERED: '1'
      TZ: Asia/Seoul

      # analyze_and_update.py 용
      ARTIFACTS_DIR: artifacts
      SHEET_ID: ${{ secrets.SHEET_ID }}
      SA_JSON: ${{ secrets.SA_JSON }}

      # Drive pull 용 (둘 중 하나만 세팅)
      DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
      # DRIVE_FOLDER_NAME: "아파트"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Drive API 클라이언트가 requirements.txt에 없으면 추가 설치
          pip install google-api-python-client

      - name: Prepare dirs
        run: |
          set -euxo pipefail
          rm -rf artifacts || true
          mkdir -p artifacts analyze_report

      - name: Pull latest xlsx from Google Drive
        run: |
          set -euxo pipefail
          python scripts/pull_from_drive.py

      - name: Debug - list artifacts
        run: |
          set -euxo pipefail
          ls -al artifacts
          find artifacts -maxdepth 2 -type f -name "*.xlsx" -print

      - name: Analyze & update Google Sheet
        run: |
          set -euxo pipefail
          python scripts/analyze_and_update.py
