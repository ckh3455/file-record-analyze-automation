name: molit

on:
  schedule:
    - cron: "05 0 * * *" # KST 09:05
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CI: "1"
      PYTHONUNBUFFERED: "1"

      # ====== 필수 ======
      SHEET_ID: ${{ secrets.SHEET_ID }}
      SA_JSON: ${{ secrets.SA_JSON }}

      # ====== Drive 입력 (권장: 상위폴더만) ======
      # 사용자가 준 링크: https://drive.google.com/drive/folders/1Og3ksryf4L25sjl-w3fKDn2U5OlWLt9E
      DRIVE_PARENT_FOLDER_ID: "1Og3ksryf4L25sjl-w3fKDn2U5OlWLt9E"

      # 공유드라이브면 true 필수
      DRIVE_SUPPORTS_ALL_DRIVES: "true"

      # (선택) 다운로드 저장 폴더
      DRIVE_DOWNLOAD_DIR: "drive_downloads"

      # (선택) 날짜 스캔 범위
      MAX_SCAN_ROWS: "900"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # requirements.txt에 없더라도 실행에 필요한 최소 패키지 보강
          pip install -U \
            pandas openpyxl numpy \
            gspread google-auth google-auth-oauthlib google-auth-httplib2

      - name: Debug - list scripts
        run: |
          set -euxo pipefail
          pwd
          ls -al
          ls -al scripts
          python -c "import gspread, google.auth; print('deps OK')"

      - name: Run analyze & update (Drive -> Sheets)
        run: |
          set -euxo pipefail
          python scripts/analyze_and_update.py

      - name: Upload analyze logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyze-report
          path: analyze_report/**
          if-no-files-found: warn
          retention-days: 3
